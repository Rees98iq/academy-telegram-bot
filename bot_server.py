import os
import logging
import random
from flask import Flask, request

# ุฅุนุฏุงุฏุงุช ุงูุชุทุจูู
app = Flask(__name__)

# ุฅุนุฏุงุฏุงุช ุงูุชุณุฌูู
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)

# ุงูุชููู
TOKEN = os.getenv('BOT_TOKEN', '8265161343:AAFgiWyxz-BSZN1MA1iu-qYdLYzlapgCJzo')
WEBHOOK_URL = os.getenv('WEBHOOK_URL', '') + '/webhook'

# ุจูุงูุงุช ุงูููุฑุณุงุช
COURSES_DATA = {
    "ุฃูุงุฏูููุฉ ููุงุฑุงุช": {
        "count": 26,
        "courses": [
            "ููุฑุณ ุฑูุตุฉ ุงูุญูุงุฉ",
            "ุงูููุฑุณ ุงูุนููุงู ุงูุจูุงุจุงุช ุงููุฌููุฉ",
            "ุนููุฏ ุงูุฃุฑูุงุญ / ุฏุฑูุณูุง / ุฅูุชุดุงู ุฑุณุงุฆู ุงูุฑูุญ",
            "ููุฑุณ ุฃููุงุน ุงููููุณ", 
            "ููุฑุณ ุชูุธูู ุฐุงูุฑุฉ ุงููุดุงุนุฑ ู ุงูุฃููุงุฑ",
            "ุญููุจูุฉ ุงููุดุงูู ุงูููุณููุฉ (10 ูุดุงูู ููุณูุฉ)",
            "ููุฑุณ ูุฏุฎู ุงูู ุนุงูู ุงูุชุฌููู",
            "ููุฑุณุงุช ูุณุงู ูุงุชู (3 ููุฑุณุงุช)",
            "ููุฑุณ ุงูุถุบูุท ุงูููุณูุฉ",
            "ููุฑุณ ููุงุฑุงุช ูุชุฏุฑูุจุงุช ูุชูููุฉ ุฐูุงุก ุงูุฃุทูุงู",
            "ุงูุฌุฑุงููู ุฏูุฒุงูู โ ูุฏุฎู ุงูู ุนุงูู ุงูุชุตููู",
            "ุดุญู ุงูุดุงูุฑุงุช ุจุงูุทุงูุฉ ุงูููููุฉ",
            "ุงูุชุตููุฑ ุงูููุชูุบุฑุงูู โ ุงููุณุชูู ุงูุงูู โ ุฑููุง ูููุฏ",
            "ููุฑุณ ุงูุชุฑุจูุฉ ุงูุฃุณุฑูุฉ",
            "ุงููุฑุญูุฉ ุงููุชูุณุทุฉ ูู ุงูุนูุงุฌ ุงูุจุฑุงูู โ ุธุงูุฑ ุงููุงุณุฑู",
            "ูู ุงุณุชูุฑุงุฑ ุงูุนูุงูุงุช โ ุงูุชูุงุตู โ",
            "ุงุชูููุช ูุจุฑูุชููู ุฏููู",
            "ููุฒูุงุก ุงููู โ ูุญูุฏ ุทู",
            "ุนููู ุฑููู",
            "ุชุทููุฑ ุฐุงุช โ ุฏูุชูุฑุฉ ุฅููุงุณ ุฑุนุฏ",
            "ุงูุณุงูููููุฌู โ ููุงุฑ ุนูุฑุงู (ุนูู ุงูุงูุบุฑุงู)",
            "ุงูุณุงูููููุฌู โ ููุงุฑ ุนูุฑุงู (ุงูููุงููู ุงูููููุฉ)",
            "ุนููู ุจุงุทููุฉ (ุงูุจุฑุงูุง)",
            "ุฑูุญุงููุงุช (ุงูุฑูุญุงููุงุช ูุนูู ุงูุฑูุญ)",
            "ุฑูุญุงููุงุช (ุนุงูู ุงููุงูุฑุงุฆูุงุช)"
        ]
    },
    "ุฏ. ููุงุฑ ุนูุฑุงู": {
        "count": 35, 
        "courses": [
            "ุงูููุฑุณ ุงูุนููุงู ุงูุจูุงุจุงุช ุงููุฌููุฉ",
            "ุงููุงุน ุงูุชุนูู",
            "ุงูุทุงูุฉ ุงูุฌูุณูุฉ",
            "ุงูููุบ ุดูู ุทุงูุฉ ุงูููุฒู", 
            "ููุงูุจ ุงูุฑูุญ",
            "ุจุงูุฉ ุญูุงูุงุช ุงูุงุทูุงู 1",
            "ุจุงูุฉ ุญูุงูุงุช ุงูุงุทูุงู 2",
            "ุทุงูุฉ ุงูุญุณุฏ",
            "ุนููู ูู ุงูุช",
            "ุงููุงุน ุงููููุณ",
            "ูุง ุจุนุฏ 2023",
            "ุงูุชุงุฑูุช",
            "ุชูุธูู ุฐุงูุฑุฉ ุงููุดุงุนุฑ ูุงูุฃููุงุฑ",
            "ูู ุงูุชูุงุตู",
            "ููู ุชููู ููุณุฑ ุญููู",
            "ุงูุดุงูุฑุงุช",
            "ููุงูุงุช ุงููุนู",
            "ุนุงูู ุงููุงูุฑุงุฆูุงุช",
            "ุงุชูููุช ูุจุฑูุชูููู ุฏููู",
            "ุงูููุงููู ุงูููููุฉ",
            "ุนููุฏ ุงูุงุฑูุงุญ", 
            "ุนูู ุงูุงููุฌุฑุงู",
            "ููุงุนูุฏ ุณุฑูุฉ - ููููุงุก ุงูุญุจ",
            "ููุฒุงู ุงูุงููุซุฉ ูุงูุฐููุฑุฉ",
            "ุงูุถุบูุท ุงูููุณูุฉ",
            "ุงูุงูุชุฆุงุจ",
            "ุงูููู",
            "ุงูุฎูู",
            "ุงูุบุถุจ",
            "ุงูุชุฃููุจ",
            "ุงูุฑูุถ",
            "ุงููุงู ูููุฉ ุงูุฐุงุช",
            "ุนูุฏุฉ ุงูููุงู", 
            "ุงูุชูุญุฏ",
            "ูุดุงูู ุนุงุทููุฉ ูุฌูุณูุฉ"
        ]
    }
}

# ูุธุงู ุงูุฐูุงุก ุงูุงุตุทูุงุนู ุงููุญูู
class LocalAI:
    def __init__(self):
        self.knowledge_base = self._build_knowledge_base()
    
    def _build_knowledge_base(self):
        return {
            "ุชุญูุฉ": [
                "๐ ุฃููุงู ูุณููุงู! ูููู ููุดุฑู ุจูู ุงูุฎูุฑ ูุงูุทุงูุฉ ุงูุฅูุฌุงุจูุฉ ๐",
                "๐ซ ูุฑุญุจุงู ุจู! ุงูููู ููุฑุณู ูู ุชุฑุฏุฏุงุช ูู ุงูุญุจ ูุงูููุฑุฉ ุงูููู โจ",
                "๐บ ุฃููุงู ุจุนุฒูุฒู! ุฃุณุนุฏ ุงููู ุตุจุงุญู ุจุงูุทุงูุฉ ูุงูุจุฑูุงุช ๐",
                "๐๏ธ ูุฑุญุจุงู! ููุฑุช ุงูููุงู ุจุทุงูุชู ุงูุฌูููุฉ ๐"
            ],
            "ุดูุฑ": [
                "๐ ุงูุนูู! ุดูุฑุงู ูุทุงูุชู ุงูุฌูููุฉ ูุชูุงุนูู ุงูุฑุงุฆุน ๐ธ", 
                "๐ ุดูุฑุงู ูู! ูุฌูุฏู ูุถูู ููุฑุงู ุฎุงุตุงู ููุฐุง ุงูููุงู โจ"
            ],
            "ุฃุณุฆูุฉ": {
                "ููู ุฃุณุฌู": "๐ **ุทุฑููุฉ ุงูุชุณุฌูู:**\n\n1. ุงุฎุชุฑ ุงูููุฑุณ ุงูููุงุณุจ\n2. ุชูุงุตู ุนุจุฑ ุงููุงุชุณุงุจ: +966XXXXXXXXX\n3. ุงุฏูุน ุงูุฑุณูู\n4. ุงุญุตู ุนูู ุงูููุงุฏ ููุฑุงู\n\n๐ ุฎุตู 10% ูููุดุชุฑููู ุงูุฌุฏุฏ!",
                "ุงูุฃุณุนุงุฑ": "๐ฐ **ุฃุณุนุงุฑ ุงูููุฑุณุงุช:**\n\nโข ุงูุฃุณุงุณูุฉ: 499 - 799 ุฑ.ุณ\nโข ุงููุชูุฏูุฉ: 899 - 1299 ุฑ.ุณ\nโข ุงูุจุงูุงุช ุงูุดุงููุฉ: 1499 - 1999 ุฑ.ุณ",
                "ุงููุฏุฉ": "โฐ **ูุฏุฉ ุงูููุฑุณุงุช:**\n\nโข ููุฑุณุงุช ูุตูุฑุฉ: 2-3 ุฃุณุงุจูุน\nโข ููุฑุณุงุช ูุชูุณุทุฉ: 4-6 ุฃุณุงุจูุน\nโข ุจุฑุงูุฌ ุดุงููุฉ: 8-12 ุฃุณุจูุน"
            }
        }
    
    def process_message(self, user_id, message):
        message_lower = message.lower()
        
        if any(word in message_lower for word in ["ูุฑุญุจุง", "ุงููุง", "ุงูุณูุงู", "ุงูููู"]):
            return random.choice(self.knowledge_base["ุชุญูุฉ"])
        
        elif any(word in message_lower for word in ["ุดูุฑ", "ููุชุงุฒ", "ุฑุงุฆุน", "ุฌููู"]):
            return random.choice(self.knowledge_base["ุดูุฑ"])
        
        elif any(word in message_lower for word in ["ุณุฌู", "ุงุดุชุฑู", "ุชุณุฌูู", "ุงุดุชุฑุงู"]):
            return self.knowledge_base["ุฃุณุฆูุฉ"]["ููู ุฃุณุฌู"]
        
        elif any(word in message_lower for word in ["ุณุนุฑ", "ุซูู", "ุชูููุฉ", "ูู ูููู"]):
            return self.knowledge_base["ุฃุณุฆูุฉ"]["ุงูุฃุณุนุงุฑ"]
        
        elif any(word in message_lower for word in ["ูุฏุฉ", "ูู ูุฏุฉ", "ูู ููุช"]):
            return self.knowledge_base["ุฃุณุฆูุฉ"]["ุงููุฏุฉ"]
        
        else:
            return "๐ฌ ููุงุณุชูุณุงุฑุงุช ุงูุชูุตูููุฉุ ุชูุงุตู ูุนูุง ุนูู ุงููุงุชุณุงุจ: +966XXXXXXXXX"

# ุฅูุดุงุก ุงูุฐูุงุก ุงูุงุตุทูุงุนู
ai_assistant = LocalAI()

# ูุญุงูุงุฉ ูุธุงุฆู ุงูุจูุช ุจุฏูู python-telegram-bot
class BotSimulator:
    def __init__(self):
        self.webhook_set = False
    
    def set_webhook(self, url):
        self.webhook_set = True
        return True
    
    def send_message(self, chat_id, text, reply_markup=None, parse_mode=None):
        print(f"๐ค Simulated message to {chat_id}: {text[:50]}...")
        return True

# ุฅูุดุงุก ูุญุงูู ุงูุจูุช
bot = BotSimulator()

# routes ููุชุทุจูู
@app.route('/')
def home():
    return """
    ๐ ุจูุช ุฃูุงุฏูููุฉ ููุงุฑุงุช ูุนูู ุจูุฌุงุญ! ๐
    
    ๐ ูุฐุง ุงูุจูุช ูุนุฑุถ ููุฑุณุงุช ุงูุฃูุงุฏูููุฉ ููุฌูุจ ุนูู ุงุณุชูุณุงุฑุงุชู.
    
    ๐ซ ุงููููุฒุงุช:
    โข ุนุฑุถ ุงูููุฑุณุงุช ุงููุชุงุญุฉ
    โข ูุนูููุงุช ุงูุฃุณุนุงุฑ ูุงูุชุณุฌูู
    โข ูุญุงุฏุซุฉ ุฐููุฉ ูุน ุงููุณุงุนุฏ
    
    ๐ ููุชูุงุตู: +966XXXXXXXXX
    """

@app.route('/webhook', methods=['POST'])
def webhook():
    try:
        data = request.get_json()
        
        # ูุญุงูุงุฉ ูุนุงูุฌุฉ ุงูุฑุณุงูุฉ
        if 'message' in data:
            message = data['message']
            chat_id = message['chat']['id']
            text = message.get('text', '')
            
            if text.startswith('/start'):
                response = "๐ **ูุฑุญุจุงู ูู ุฃูุงุฏูููุฉ ููุงุฑุงุช!**\n\nุงุฎุชุฑ ูู ุงููุงุฆูุฉ:\nโข /courses - ุนุฑุถ ุงูููุฑุณุงุช\nโข /pricing - ุงูุฃุณุนุงุฑ\nโข /contact - ุงูุชูุงุตู"
            elif text.startswith('/courses'):
                courses = COURSES_DATA["ุฃูุงุฏูููุฉ ููุงุฑุงุช"]["courses"][:5]
                response = "๐ **ุงูููุฑุณุงุช ุงููุชุงุญุฉ:**\n\n" + "\n".join([f"โข {course}" for course in courses]) + "\n\n๐ฌ ูููุฒูุฏ: +966XXXXXXXXX"
            elif text.startswith('/pricing'):
                response = "๐ฐ **ุงูุฃุณุนุงุฑ:**\n\nโข ุงูุฃุณุงุณูุฉ: 499-799 ุฑ.ุณ\nโข ุงููุชูุฏูุฉ: 899-1299 ุฑ.ุณ\n\n๐ ุฎุตู 10% ูููุดุชุฑููู ุงูุฌุฏุฏ!"
            elif text.startswith('/contact'):
                response = "๐ **ุงูุชูุงุตู:**\n\n๐ฌ ุงููุงุชุณุงุจ: +966XXXXXXXXX\n๐ง ุงูุจุฑูุฏ: info@manarat-academy.com"
            else:
                response = ai_assistant.process_message(chat_id, text)
            
            # ูู ุชุทุจูู ุญููููุ ููุง ูุฑุณู ุงูุฑุณุงูุฉ ููุจูุช
            print(f"๐ค Response: {response}")
            
        return 'OK'
    except Exception as e:
        print(f"Webhook error: {e}")
        return 'Error', 500

@app.route('/set_webhook')
def set_webhook():
    try:
        if WEBHOOK_URL and 'render.com' in WEBHOOK_URL:
            success = bot.set_webhook(WEBHOOK_URL)
            return f"โ Webhook setup: {success}"
        return "โ WEBHOOK_URL not set properly"
    except Exception as e:
        return f"โ Error: {e}"

@app.route('/courses')
def courses_page():
    courses = COURSES_DATA["ุฃูุงุฏูููุฉ ููุงุฑุงุช"]["courses"]
    courses_html = "<h1>๐ฏ ููุฑุณุงุช ุฃูุงุฏูููุฉ ููุงุฑุงุช</h1><ul>"
    for course in courses:
        courses_html += f"<li>{course}</li>"
    courses_html += f"</ul><p><strong>ุงูุฅุฌูุงูู: {len(courses)} ููุฑุณ</strong></p>"
    courses_html += "<p>๐ฌ ููุงุณุชูุณุงุฑ: +966XXXXXXXXX</p>"
    return courses_html

@app.route('/pricing')
def pricing_page():
    return """
    <h1>๐ฐ ุฃุณุนุงุฑ ุงูููุฑุณุงุช</h1>
    <ul>
        <li>ุงูููุฑุณุงุช ุงูุฃุณุงุณูุฉ: 499 - 799 ุฑ.ุณ</li>
        <li>ุงูููุฑุณุงุช ุงููุชูุฏูุฉ: 899 - 1299 ุฑ.ุณ</li>
        <li>ุงูุจุงูุงุช ุงูุดุงููุฉ: 1499 - 1999 ุฑ.ุณ</li>
    </ul>
    <p>๐ ุฎุตู 10% ูููุดุชุฑููู ุงูุฌุฏุฏ</p>
    <p>๐ ููุงุณุชูุณุงุฑ: +966XXXXXXXXX</p>
    """

@app.route('/contact')
def contact_page():
    return """
    <h1>๐ ุชูุงุตู ูุนูุง</h1>
    <p>๐ฌ ุงููุงุชุณุงุจ: +966XXXXXXXXX</p>
    <p>๐ง ุงูุจุฑูุฏ: info@manarat-academy.com</p>
    <p>๐ ุงููููุน: www.manarat-academy.com</p>
    <p>๐ ุฃููุงุช ุงูุฏุนู: 9 ุต - 6 ู</p>
    """

# ุงูุชุดุบูู ุงูุฑุฆูุณู
if __name__ == '__main__':
    port = int(os.environ.get('PORT', 5000))
    
    # ุฅุนุฏุงุฏ webhook ุชููุงุฆูุงู
    try:
        if WEBHOOK_URL and 'render.com' in WEBHOOK_URL:
            bot.set_webhook(WEBHOOK_URL)
            print(f"โ Webhook set to: {WEBHOOK_URL}")
    except Exception as e:
        print(f"โ๏ธ  Webhook error: {e}")
    
    print("๐ Starting Flask app...")
    app.run(host='0.0.0.0', port=port, debug=False)
